<!DOCTYPE html>
<html>
	<head>
		<title>cloud.jamesoff.net</title>
	</head>
	<body>
		<script src="https://sdk.amazonaws.com/js/aws-sdk-2.258.1.min.js"></script>
		<script src="config.js"></script>
		DIY cloud hosting.<br />
		<br />

		<script>
			function getHashDict() {
				var hash = window.location.hash.replace('#','');
				var keyValuePairs = hash.split('&');
				var ret = {};
				for (pair of keyValuePairs) {
					var values = pair.split('=');
					ret[values[0]] = values[1];
				}
				return ret;
			}

			function addPhoto() {
				var files = document.getElementById('photoupload').files;
				if (!files.length) {
					return alert('Please choose a file to upload first.');
				}
				var file = files[0];
				var fileName = file.name;
				var prefix = 'assets/';

				var imageKey = prefix + fileName;
				s3.upload({
					Key: imageKey,
					Body: file,
					ACL: 'public-read'
				}, function(err, data) {
					if (err) {
						return alert('There was an error uploading your image: ', err.message);
					}
					alert('Successfully uploaded image.');
					var params = {
						QueueUrl: cloudConfig['QueueURL'],
						AttributeNames: ['All'],
						MaxNumberOfMessages: 1,
						MessageAttributeNames: ['All'],
						VisibilityTimeout: 10,
						WaitTimeSeconds: 20
					};
					sqs.receiveMessage(params, function(err, data) {
						if (err) console.log(err, err.stack);
						else {
							console.log(data);
							var message = data.Messages[0];
							var body = message.Body;
							var info = body.split('=');
							var image_id = info[1];
							document.getElementById('imageinfo').innerHTML = "<a href='https://" + cloudConfig['Bucket'] + "/" + image_id + "'>link</a>";
							var params = {
								QueueUrl: cloudConfig['QueueURL'],
								ReceiptHandle: message.ReceiptHandle
							};
							sqs.deleteMessage(params, function(err, data) {
								if (err) console.log(err, err.stack); // an error occurred
								else     console.log(data);           // successful response
							});
						};
					});
				});
			}

			var hashValues = getHashDict();

			if (Object.keys(hashValues).length > 1) {
				var creds = new AWS.CognitoIdentityCredentials({
					IdentityPoolId: cloudConfig['IdentityPool'],
					Logins: { [cloudConfig['LoginPool']]: hashValues['id_token'] },
					RoleSessionName: 'moo'
				},
				{
					region: cloudConfig['Region']
				});
				creds.refresh(function(err) { if (err) console.log(err, err.stack) } );
				AWS.config.credentials = creds;
				var s3 = new AWS.S3({
					region: cloudConfig['Region'],
					params: { Bucket: cloudConfig['Bucket'] }
				});
				var sqs = new AWS.SQS({
					region: cloudConfig['Region']
				});
			}
			else {
				window.location.href = 'https://' + cloudConfig['AuthHost'] + '/login?response_type=token&client_id=' + cloudConfig['ApplicationID'] + '&redirect_uri=' + window.location.href;
			}

		</script>
		<input id="photoupload" type="file" accept="image/*">
		<button id="addphoto" onclick="addPhoto()">Add Image</button>
		<div id="imageinfo"></div>
	</body>
</html>
